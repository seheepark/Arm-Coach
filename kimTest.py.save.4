import socket
import MySQLdb
import mibanda
import time

server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server_socket.bind(("", 5001))
server_socket.listen(5)
print("wating...")
db=MySQLdb.connect('localhost','root','root','kim')
#connect database schema
cursor=db.cursor()
cursor.execute("USE kim")

#connect miband using bluetooth
sd=mibanda.DiscoveryService()
device=mibanda.BandDeviceService()
device=mibanda.BandDevice("88:0f:10:96:b1:4b", "MI")
device.connect()
print ("connect miband")

#connect edison-android
while 1:
	client_socket, address=server_socket.accept()
	print ("connect from" ,address)
	connectEvent=0
	countLoop=0
	data=client_socket.recv(1024)
	countTime=0
	print(data)
	
	while 1:
		if connectEvent==0:
			data2=data.split('.')
			print (data2)
			UserName=data2[0]
			Gender=data2[1]
			Age=int(data2[2])
			Event=data2[3]
			Height=int(data2[4])
			Weight=int(data2[5])
			TargetRange=int(data2[6])#Goal
			TargetTime=int(data2[7])#Goal
			First=int(data2[8])#first run or second,third....
			averageRange=(Height*0.37 + Height-100)/2 #walk range
			connectEvent=1 
			if Event=="MARATHON": #init marathon values
				Voltage=TargetRange/TargetTime
				str="INSERT INTO marathon VALUES(%d,%d,%d,%d,%d,%d,%d,%d,%d,%d)" % (Voltage,Voltage,Voltage,Voltage,Voltage,Voltage,Voltage,Voltage,Voltage)
				cursor.execute(str)
		if Event=="MARATHON":
			cursor.execute("select * from marathon")
			while True:
				row=cursor.fetchone()
				if row==None:
					break;
			record=[" "]
			timeFirst=0
			count=0
			while True:
				sector=TargetRange/10
 				NowSteps=80#device.getSteps()
				SectorSteps=NowSteps-Steps
				Steps=20#NowSteps
				movement=averageRange*SectorSteps
				if movement>sector:	#in sector
					time1=time.time()-t #time
					time=time1-timeFirst #
					timeFirst=time1
					v=movement/time #sector voltage
					if row[count]>v:
						print ("slow")
					else:
						print("fast")

					s=`count`
					s="sector"+s
					str="UPDATE marathon SET %s = \"%d\"" % (s,v)
					cursor.execute(str)
					record.append(v)
					count=count+1
					db.commit()
				elif (time.time()-t)%300==0:			#not sector.
					if row[count]>v:
						print ("slow")
					else:
						print("fast")

				if count==10:
					record.remove(" ")
					str="INSERT IN record VALUES(%d,%d,%d,%d,%d,%d,%d,%d,%d,%d)" % (record[0],record[1],record[2],record[3],record[4],record[5],record[6],record[8],record[9])
					cursor.execute(str)
					db.commit()
					break
	
#finish marathon
			averageList=[" "]
			countList=0
			cursor.execute("select * from record")
			while True:
				row=cursor.fetchone()
				if row==None:
					break;
				else:
					average=row[0]+row[1]+row[2]+row[3]+row[4]+row[5]+row[6]+row[7]+row[8]+row[9]
					averageList.append(average)
					countList=countList+1
			averageList.remove(" ")
			if countList!=0 or countList!=1:
	#cursor.execute("DELETE FROM record")
				if (averageList[countList]-averageList[0])/countList>0:
					print("up ! goodboy")
				else:
					print("badboy! down")
				if (averageList[countList]-averageList[countList])>0:
					print("yesterday better")
				else:
					print("yesterday notgoods")

		break				
		if Event=="JOGGING":
			#cursor.execute("select * from jogging")
			firstV = 5 #firstV =  round((TargetRange / TargetTime), 2)
			steps = 50
			NowSteps = 80
			dist = averageRange*(NowSteps - steps)
			spendTime = time.time()-t
			currentV = 22#round(dist/spendTime, 2)
	
			if First==1:
				str="INSERT INTO jogging VALUES(%d)" % (firstV)
 				cursor.execute(str)
				str="INSERT INTO jogging VALUES(%d)" % (currentV)
				cursor.execute(str)
				db.commit()
				#if currentV < firstV
				#	print ("Hurry Up")
				#elif currentV > firstV
				#	print ("Run Slow")
				#else
				#	print("Good, cheer up!!")
			else:
				str="SELECT * FROM jogging ORDER BY day"
				cursor.execute(str)
				result=cursor.fetchall()
				total=len(result)
				str="SELECT AVG(velocity) FROM jogging"
				avg = cursor.execute(str)
				currentV = round(dist/spendTime, 2)
				sum = 0									
				stdDeviation = 0	
	
				dayVelocity = {}
		
				if total < 1:
					print ("No daliy velocity entries!")
				else:
					for i in range(total):
						dayVelocity[i] = result[i][1] #velocity	
						sum += pow(abs(avg-velocity[i]), 2)
						stdDeviation = round(sqrt(sum/total), 2)
					tmp = avg-stdDeviation
					if tmp > currentV:							
						print("Hurry Up")
					elif tmp < currentV:
						print("Run Slow")
					else:
						print("Good, cheer up!!")
				str="INSERT INTO jogging VALUES(%d)" % (currentV)
				cursor.execute(str)
				db.commit()
		if Event=="Player-soccer":
			while True:
				# player press button
				data2 = data.split('.')
			
				if data2 == 'start': #if player press start button
					tmpStep1 = device.getSteps() # from miband
				elif data2 == 'end': # if player press ending button
					tmpStep2 = device.getSteps() # from miband
					totalSteps = tmpStep2 - tmpStep1
					move = ((Height-100)*totalSteps)/100 # player's moving distance
					countStr = "select Count(move) from value1"
					cursor.execute(countStr)
					count = cursor.fetchone()
					db.commit()
					
					for c in count:
						if c == 4: # if table size is maximum
							
						else:
							insertStr = "INSERT INTO (value1) VALUES (%d)" % (move)
							cursor.execute(insertStr)
							db.commit()
	break
db.close()
server_socket.close()
print("close")
